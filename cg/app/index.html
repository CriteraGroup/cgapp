<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Critera Group</title>
  <link rel="stylesheet" href="app.css">
  <link rel="stylesheet" href="../messenger/messenger.css">
</head>
<body>
<header class="app-header">
  Critera Group
  <button id="exit" onclick="exit();">Exit</button>
  <button id="save" onclick="save();">Save</button>
</header>

<table id="content">
  <thead>
    <td>Question</td>
    <td>Answer</td>
    <td>Finding</td>
    <td>Reason</td>
    <td>Status</td>
  </thead>
</table>
<script>
  __cg = {};
</script>
<script>
  var ipc = require('electron').ipcRenderer;

  document.addEventListener('DOMContentLoaded', bodyLoaded);

  function bodyLoaded() {
    ipc.send('bodyLoaded');
    ipc.once('bodyLoadedReply', function(response, data) {
      var group, question, answer, finding, reason, status, rating1, rating2, rating3, questionContainer,
        answerContainer, findingContainer, reasonContainer, statusContainer;
      var content = document.getElementById('content'),
        dataLength = data.length;

      for(var i = 0; i < dataLength; i++) {
        group = document.createElement('tr');

        questionContainer = document.createElement('td');
        answerContainer = document.createElement('td');
        findingContainer = document.createElement('td');
        reasonContainer = document.createElement('td');
        statusContainer = document.createElement('td');

        question = document.createElement('span');
        answer = document.createElement('textarea');
        finding = document.createElement('textarea');
        reason = document.createElement('textarea');
        status = document.createElement('select');

        rating1 = document.createElement('option');
        rating2 = document.createElement('option');
        rating3 = document.createElement('option');

        group.className = 'question-group';
        question.className = 'question';
        answer.className = 'answer';
        finding.className = 'finding';
        reason.className = 'reason';
        status.className = 'status';

        rating1.value = 1;
        rating2.value = 0.5;
        rating3.value = 0;

        rating1.textContent = 'Compliant';
        rating2.textContent = 'Partially Compliant';
        rating3.textContent = 'Non Compliant';

        question.innerHTML = data[i][0];
        answer.value = data[i][1];
        finding.value = data[i][2];
        reason.value = data[i][3];
        status.value = data[i][4];

        status.appendChild(rating1);
        status.appendChild(rating2);
        status.appendChild(rating3);

        setStatus(status, data[i][4]);

        questionContainer.appendChild(question);
        answerContainer.appendChild(answer);
        findingContainer.appendChild(finding);
        reasonContainer.appendChild(reason);
        statusContainer.appendChild(status);

        group.appendChild(questionContainer);
        group.appendChild(answerContainer);
        group.appendChild(findingContainer);
        group.appendChild(reasonContainer);
        group.appendChild(statusContainer);

        content.appendChild(group);
      }

      function setStatus(status, dataValue) {
        var i,
          options = status.options,
          size = options.length;

        for(i = 0; i < size; i++) {
          if(options[i].value == dataValue) {
            status.selectedIndex = i;
            break;
          }
        }
      }
    });
    ipc.on('success-message', function(event, msg) {
      __cg.messenger.success(msg);
    })
  }

  function exit() {
    console.log('Sending exit event');
    ipc.send('exit');
  }

  function save() {
    var row, i;
    var rows = document.querySelectorAll('.question-group');
    var size = rows.length;

    var saveData = [];

    for(i = 0; i < size; i++) {
      row = rows[i];

      saveData.push([
        row.querySelector('.question').textContent,
        row.querySelector('.answer').value,
        row.querySelector('.finding').value,
        row.querySelector('.reason').value,
        row.querySelector('.status').value
      ]);
    }

    ipc.send('save', saveData);
  }
</script>
<script src="../messenger/messenger.js">

</script>
</body>
</html>
